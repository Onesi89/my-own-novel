/**
 * Map Route Selector Widget
 * FSD: widgets/main
 * 
 * Íµ¨Í∏Ä ÏßÄÎèÑ Í∏∞Î∞ò Ïù¥ÎèôÍ≤ΩÎ°ú ÏÑ†ÌÉù UI Ïª¥Ìè¨ÎÑåÌä∏
 * ÏÉà ÏÜåÏÑ§ ÎßåÎì§Í∏∞ ÌÅ¥Î¶≠ Ïãú ÌëúÏãúÎêòÎäî ÏßÄÎèÑ Î∑∞
 */

'use client'

import React, { useState, useEffect, useCallback } from 'react'
import { 
  MapPin, 
  Navigation, 
  Check, 
  X, 
  ArrowLeft,
  Map,
  Route,
  Clock,
  Trash2,
  Plus,
  ArrowUp
} from 'lucide-react'
import { 
  Card, 
  CardContent, 
  CardDescription, 
  CardHeader, 
  CardTitle,
  Button,
  Badge,
  Separator
} from '@/shared/ui'
import { GoogleMapComponent, PlaceSearchBox, MapContainer } from '@/features/map'
import { usePathname } from 'next/navigation'
import { randomUUID } from 'crypto'

interface PlaceInfo {
  customName?: string
  category: 'home' | 'work' | 'leisure' | 'shopping' | 'dining' | 'transport' | 'other'
  description?: string
  storyHint?: string
  isPrivate?: boolean
  visitTime?: string
  duration?: number
}

interface RoutePoint {
  id: string
  lat: number
  lng: number
  timestamp: string
  address?: string
  duration?: number
  isSelected: boolean
  customInfo?: PlaceInfo
  storyPriority?: number
}

interface PlaceSearchResult {
  placeId: string
  name: string
  address: string
  location: {
    lat: number
    lng: number
  }
  types: string[]
  rating?: number
  priceLevel?: number
}

interface MapRouteSelectorProps {
  timelineData: any[]
  onRouteSelect: (selectedRoutes: RoutePoint[]) => void
  onCancel: () => void
  maxRoutes?: number
}

export function MapRouteSelector({ 
  timelineData, 
  onRouteSelect, 
  onCancel,
  maxRoutes = 5 
}: MapRouteSelectorProps) {
  const [selectedRoutes, setSelectedRoutes] = useState<RoutePoint[]>([])
  const [availableRoutes, setAvailableRoutes] = useState<RoutePoint[]>([])
  const [currentView, setCurrentView] = useState<'map' | 'list'>('map')
  const [highlightedRouteId, setHighlightedRouteId] = useState<string | null>(null)

  // Ï¢åÌëú Ï†ïÍ∑úÌôî Î∞è Í≤ÄÏ¶ù Ìï®Ïàò
  const normalizeCoordinate = (coord: number, type: 'lat' | 'lng'): number => {
    if (type === 'lat') {
      // E7 ÌòïÏãù Í≤ÄÏ¶ù: ÏúÑÎèÑÎäî -90ÎèÑ~90ÎèÑ Î≤îÏúÑÎ•º Î≤óÏñ¥ÎÇòÎ©¥ E7 ÌòïÏãùÏúºÎ°ú Í∞ÑÏ£º
      if (Math.abs(coord) > 90) {
        return coord / 1e7
      }
      return coord
    } else {
      // E7 ÌòïÏãù Í≤ÄÏ¶ù: Í≤ΩÎèÑÎäî -180ÎèÑ~180ÎèÑ Î≤îÏúÑÎ•º Î≤óÏñ¥ÎÇòÎ©¥ E7 ÌòïÏãùÏúºÎ°ú Í∞ÑÏ£º
      if (Math.abs(coord) > 180) {
        return coord / 1e7
      }
      return coord
    }
  }

  // Ï¢åÌëú Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨ Ìï®Ïàò
  const isValidCoordinate = (lat: number, lng: number): boolean => {
    return lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180
  }

  // ÌÉÄÏûÑÎùºÏù∏ Îç∞Ïù¥ÌÑ∞Î•º RoutePointÎ°ú Î≥ÄÌôò
  useEffect(() => {
    if (timelineData && timelineData.length > 0) {
      console.log('Processing timeline data:', timelineData.length, 'locations')
      console.log('Sample location data:', timelineData[0])
      
      const routes = timelineData
        .filter(item => {
          // latitude/longitude ÎòêÎäî lat/lng ÌïÑÎìú ÌôïÏù∏
          const hasLatLng = (item.lat !== undefined && item.lng !== undefined) || 
                           (item.latitude !== undefined && item.longitude !== undefined)
          return hasLatLng
        })
        .map((item, index) => {
          // latitude/longitude ÎòêÎäî lat/lng ÌïÑÎìúÎ•º Ï†ïÍ∑úÌôî
          const rawLat = item.lat ?? item.latitude ?? 0
          const rawLng = item.lng ?? item.longitude ?? 0
          
          // Ï¢åÌëú Ï†ïÍ∑úÌôî
          const normalizedLat = normalizeCoordinate(rawLat, 'lat')
          const normalizedLng = normalizeCoordinate(rawLng, 'lng')
          
          // Ï¢åÌëú Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨
          if (!isValidCoordinate(normalizedLat, normalizedLng)) {
            console.warn(`Invalid coordinates for item ${index}:`, {
              raw: { lat: rawLat, lng: rawLng },
              normalized: { lat: normalizedLat, lng: normalizedLng }
            })
            return null
          }
          
          return {
            id: `route-${item.id || index}`,
            lat: normalizedLat,
            lng: normalizedLng,
            timestamp: item.timestamp || new Date().toISOString(),
            address: item.address || `ÏúÑÏπò ${index + 1}`,
            duration: item.duration || 30,
            isSelected: false
          }
        })
        .filter(Boolean) // null Í∞í Ï†úÍ±∞
      
      console.log('Processed routes:', routes.length, routes.slice(0, 3))
      console.log('Available routes set, length:', routes.length)
      setAvailableRoutes(routes)
    } else {
      console.log('No timeline data available')
      setAvailableRoutes([])
    }
  }, [timelineData])

  // Í≤ΩÎ°ú ÏÑ†ÌÉù/Ìï¥Ï†ú Ìï∏Îì§Îü¨
  const handleRouteToggle = useCallback((routeId: string) => {
    setSelectedRoutes(prev => {
      const existing = prev.find(r => r.id === routeId)
      if (existing) {
        // Ïù¥ÎØ∏ ÏÑ†ÌÉùÎêú Í≤ΩÎ°úÎ©¥ Ï†úÍ±∞
        return prev.filter(r => r.id !== routeId)
      } else {
        // ÏµúÎåÄ Í∞úÏàò Ï≤¥ÌÅ¨
        if (prev.length >= maxRoutes) {
          return prev
        }
        // ÏÉà Í≤ΩÎ°ú Ï∂îÍ∞Ä
        const routeToAdd = availableRoutes.find(r => r.id === routeId)
        return routeToAdd ? [...prev, { ...routeToAdd, isSelected: true }] : prev
      }
    })
  }, [availableRoutes, maxRoutes])

  // Î™®Îì† Í≤ΩÎ°ú ÏÑ†ÌÉù Ìï¥Ï†ú
  const handleClearAll = () => {
    setSelectedRoutes([])
  }

  // ÏÑ†ÌÉù ÏôÑÎ£å
  const handleConfirmSelection = () => {
    if (selectedRoutes.length > 0) {
      onRouteSelect(selectedRoutes)
    }
  }

  // ÏãúÍ∞Ñ Ìè¨Îß∑ÌåÖ
  const formatTime = (timestamp: string) => {
    return new Date(timestamp).toLocaleTimeString('ko-KR', {
      hour: '2-digit',
      minute: '2-digit'
    })
  }

  // ÎÇ†Ïßú Ìè¨Îß∑ÌåÖ
  const formatDate = (timestamp: string) => {
    return new Date(timestamp).toLocaleDateString('ko-KR', {
      month: 'short',
      day: 'numeric'
    })
  }

  // Ïπ¥ÌÖåÍ≥†Î¶¨ ÏïÑÏù¥ÏΩò Îß§Ìïë
  const getCategoryIcon = (category: PlaceInfo['category']) => {
    const icons = {
      home: 'üè†',
      work: 'üè¢',
      dining: 'üçΩÔ∏è',
      shopping: 'üõçÔ∏è',
      leisure: 'üéÆ',
      transport: 'üöó',
      other: 'üìç'
    }
    return icons[category] || 'üìç'
  }

  // Ïû•ÏÜå Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
  const updatePlaceInfo = useCallback((routeId: string, placeInfo: PlaceInfo, timeData?: { visitTime: string, duration: number }) => {
    const updateRoute = (route: RoutePoint) => {
      if (route.id !== routeId) return route
      
      const updatedRoute = { ...route, customInfo: placeInfo }
      
      // ÏãúÍ∞Ñ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏûàÏúºÎ©¥ ÏóÖÎç∞Ïù¥Ìä∏
      if (timeData) {
        updatedRoute.timestamp = timeData.visitTime
        updatedRoute.duration = timeData.duration
      }
      
      return updatedRoute
    }
    
    setAvailableRoutes(prev => prev.map(updateRoute))
    setSelectedRoutes(prev => prev.map(updateRoute))
  }, [])

  // ÏàòÎèô Í≤ΩÎ°ú Ï∂îÍ∞Ä
  const addManualRoute = useCallback((lat: number, lng: number, address?: string) => {
    const newRoute: RoutePoint = {
      id: `manual-${Date.now()}`,
      lat,
      lng,
      timestamp: new Date().toISOString(),
      address: address || `ÏàòÎèô Ï∂îÍ∞Ä ÏúÑÏπò (${lat.toFixed(4)}, ${lng.toFixed(4)})`,
      duration: 30,
      isSelected: false
    }
    
    setAvailableRoutes(prev => [...prev, newRoute])
  }, [])

  // Í≤ÄÏÉâ Í≤∞Í≥ºÎ°ú Í≤ΩÎ°ú Ï∂îÍ∞Ä
  const handlePlaceSearch = useCallback((place: PlaceSearchResult) => {
    const newRoute: RoutePoint = {
      id: `search-${place.placeId}-${Date.now()}`,
      lat: place.location.lat,
      lng: place.location.lng,
      timestamp: new Date().toISOString(),
      address: place.address,
      duration: 30,
      isSelected: false,
      customInfo: {
        customName: place.name,
        category: inferCategoryFromTypes(place.types),
        description: '', // Í∏∞Î≥∏Í∞íÏùÑ Îπà Î¨∏ÏûêÏó¥Î°ú ÏÑ§Ï†ïÌïòÏó¨ ÏÇ¨Ïö©ÏûêÍ∞Ä ÏßÅÏ†ë ÏûÖÎ†•ÌïòÎèÑÎ°ù Ìï®
        storyHint: '' // Í∏∞Î≥∏Í∞íÏùÑ Îπà Î¨∏ÏûêÏó¥Î°ú ÏÑ§Ï†ïÌïòÏó¨ ÏÇ¨Ïö©ÏûêÍ∞Ä ÏßÅÏ†ë ÏûÖÎ†•ÌïòÎèÑÎ°ù Ìï®
      }
    }
    
    setAvailableRoutes(prev => [...prev, newRoute])
    
    // ÏûêÎèôÏúºÎ°ú ÏÑ†ÌÉù (5Í∞ú ÎØ∏ÎßåÏù∏ Í≤ΩÏö∞)
    if (selectedRoutes.length < maxRoutes) {
      setSelectedRoutes(prev => [...prev, { ...newRoute, isSelected: true }])
    }
    
    // Í≤ÄÏÉâÏúºÎ°ú Ï∂îÍ∞ÄÎêú Ïû•ÏÜåÎ•º ÏßÄÎèÑÏóêÏÑú ÌïòÏù¥ÎùºÏù¥Ìä∏
    setHighlightedRouteId(newRoute.id)
    
    // 3Ï¥à ÌõÑ ÌïòÏù¥ÎùºÏù¥Ìä∏ Ìï¥Ï†ú
    setTimeout(() => {
      setHighlightedRouteId(null)
    }, 3000)
  }, [selectedRoutes.length, maxRoutes])

  // Ïû•ÏÜå ÌÉÄÏûÖÏóêÏÑú Ïπ¥ÌÖåÍ≥†Î¶¨ Ï∂îÎ°†
  const inferCategoryFromTypes = (types: string[]): PlaceInfo['category'] => {
    const typeMap: Record<string, PlaceInfo['category']> = {
      'restaurant': 'dining',
      'cafe': 'dining',
      'food': 'dining',
      'meal_takeaway': 'dining',
      'shopping_mall': 'shopping',
      'store': 'shopping',
      'clothing_store': 'shopping',
      'hospital': 'other',
      'school': 'work',
      'university': 'work',
      'bank': 'other',
      'gas_station': 'transport',
      'subway_station': 'transport',
      'bus_station': 'transport',
      'train_station': 'transport',
      'park': 'leisure',
      'amusement_park': 'leisure',
      'gym': 'leisure',
      'spa': 'leisure',
      'library': 'leisure',
      'movie_theater': 'leisure',
      'home_goods_store': 'shopping'
    }

    for (const type of types) {
      if (typeMap[type]) {
        return typeMap[type]
      }
    }
    
    return 'other'
  }

  return (
    <MapContainer>
      {(isGoogleLoaded) => (
        <div className="min-h-screen bg-gradient-to-br from-blue-50 via-white to-purple-50">
      {/* Header */}
      <header className="bg-white/80 backdrop-blur-sm border-b border-gray-200 sticky top-0 z-50" onClick={onCancel}>
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex items-center justify-between h-16">
            {/* Back Button & Title */}
            <div className="flex items-center gap-4">
              <div className="flex items-center gap-2">
                <Map className="w-6 h-6 text-blue-600" />
                <h1 className="text-xl font-bold text-gray-900">Ïù¥Îèô Í≤ΩÎ°ú ÏÑ†ÌÉù</h1>
              </div>
            </div>

            {/* View Toggle & Actions */}
            <div className="flex items-center gap-3">
              <div className="flex items-center bg-gray-100 rounded-lg p-1">
                <Button
                  variant={currentView === 'map' ? 'default' : 'ghost'}
                  size="sm"
                  onClick={() => setCurrentView('map')}
                  className="text-xs"
                >
                  <Map className="w-4 h-4 mr-1" />
                  ÏßÄÎèÑ
                </Button>
                <Button
                  variant={currentView === 'list' ? 'default' : 'ghost'}
                  size="sm"
                  onClick={() => setCurrentView('list')}
                  className="text-xs"
                >
                  <Route className="w-4 h-4 mr-1" />
                  Î™©Î°ù
                </Button>
              </div>
              
              <Separator orientation="vertical" className="h-6" />
              
              <div className="flex items-center gap-2">
                <Badge variant="outline" className="text-xs">
                  {selectedRoutes.length}/{maxRoutes} ÏÑ†ÌÉù
                </Badge>
                {selectedRoutes.length > 0 && (
                  <Button
                    variant="ghost"
                    size="sm"
                    onClick={handleClearAll}
                    className="text-xs text-red-600 hover:text-red-700"
                  >
                    <Trash2 className="w-4 h-4 mr-1" />
                    Ï†ÑÏ≤¥ Ìï¥Ï†ú
                  </Button>
                )}
              </div>
            </div>
          </div>
        </div>
      </header>

      {/* Main Content */}
      <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <div className="grid grid-cols-1 lg:grid-cols-4 gap-6">
          
          {/* Map/List View */}
          <div className="lg:col-span-3">
            {currentView === 'map' ? (
              <Card className="h-[700px]">
                <CardHeader className="pb-4">
                  <CardTitle className="flex items-center gap-2">
                    <MapPin className="w-5 h-5" />
                    ÏßÄÎèÑÏóêÏÑú Í≤ΩÎ°ú ÏÑ†ÌÉù
                  </CardTitle>
                  <CardDescription>
                    Ïû•ÏÜåÎ•º Í≤ÄÏÉâÌïòÍ±∞ÎÇò ÏßÄÎèÑÎ•º ÌÅ¥Î¶≠ÌïòÏó¨ ÏµúÎåÄ {maxRoutes}Í∞úÏùò Ïù¥Îèô Í≤ΩÎ°úÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.
                  </CardDescription>
                  
                  {/* Í≤ÄÏÉâÎ∞ïÏä§ */}
                  {isGoogleLoaded && (
                    <div className="mt-4">
                      <PlaceSearchBox
                        onPlaceSelect={handlePlaceSearch}
                        onLocationSelect={addManualRoute}
                        placeholder="Ïû•ÏÜåÎÇò Ï£ºÏÜåÎ•º Í≤ÄÏÉâÌïòÏÑ∏Ïöî..."
                        className="w-full"
                      />
                    </div>
                  )}
                </CardHeader>
                <CardContent className="p-0 h-[500px]">
                  {isGoogleLoaded ? (
                    <GoogleMapComponent
                      routes={availableRoutes}
                      selectedRoutes={selectedRoutes}
                      onRouteClick={handleRouteToggle}
                      onRouteEdit={updatePlaceInfo}
                      onAddManualRoute={addManualRoute}
                      highlightedRouteId={highlightedRouteId}
                      height="100%"
                    />
                  ) : (
                    <div className="flex items-center justify-center h-full">
                      <div className="text-center">
                        <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"></div>
                        <p className="text-gray-600">ÏßÄÎèÑ Ï¥àÍ∏∞Ìôî Ï§ë...</p>
                      </div>
                    </div>
                  )}
                </CardContent>
              </Card>
            ) : (
              <Card>
                <CardHeader>
                  <CardTitle className="flex items-center gap-2">
                    <Route className="w-5 h-5" />
                    Ïù¥Îèô Í≤ΩÎ°ú Î™©Î°ù
                  </CardTitle>
                  <CardDescription>
                    ÏïÑÎûò Î™©Î°ùÏóêÏÑú ÏÜåÏÑ§Ïóê Ìè¨Ìï®Ìï† Ïù¥Îèô Í≤ΩÎ°úÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî
                  </CardDescription>
                </CardHeader>
                <CardContent className="max-h-[600px] overflow-y-auto">
                  <div className="space-y-3">
                    {availableRoutes.map((route, index) => {
                      const isSelected = selectedRoutes.some(r => r.id === route.id)
                      const canSelect = selectedRoutes.length < maxRoutes || isSelected
                      
                      return (
                        <div
                          key={route.id}
                          className={`
                            p-4 rounded-lg border cursor-pointer transition-all
                            ${isSelected 
                              ? 'bg-blue-50 border-blue-200 ring-2 ring-blue-500/20' 
                              : canSelect 
                                ? 'bg-white border-gray-200 hover:bg-gray-50 hover:border-gray-300' 
                                : 'bg-gray-50 border-gray-200 opacity-50 cursor-not-allowed'
                            }
                          `}
                          onClick={() => canSelect && handleRouteToggle(route.id)}
                          role="button"
                          tabIndex={canSelect ? 0 : -1}
                          aria-label={`Í≤ΩÎ°ú ${index + 1} ${isSelected ? 'ÏÑ†ÌÉùÎê®' : 'ÏÑ†ÌÉù ÏïàÎê®'}`}
                          onKeyDown={(e) => {
                            if (canSelect && (e.key === 'Enter' || e.key === ' ')) {
                              e.preventDefault()
                              handleRouteToggle(route.id)
                            }
                          }}
                        >
                          <div className="flex items-center justify-between">
                            <div className="flex items-center gap-3">
                              <div className={`
                                w-10 h-10 rounded-full flex items-center justify-center
                                ${isSelected ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-600'}
                              `}>
                                {isSelected ? (
                                  <Check className="w-5 h-5" />
                                ) : (
                                  <span className="text-sm font-medium">{index + 1}</span>
                                )}
                              </div>
                              <div className="flex-1">
                                <div className="flex items-center gap-2">
                                  <h3 className="font-medium text-gray-900">
                                    {route.address}
                                  </h3>
                                  <Badge variant="outline" className="text-xs">
                                    {formatDate(route.timestamp)}
                                  </Badge>
                                </div>
                                <div className="flex items-center gap-4 text-sm text-gray-500 mt-1">
                                  <span className="flex items-center gap-1">
                                    <Clock className="w-3 h-3" />
                                    {formatTime(route.timestamp)}
                                  </span>
                                  <span className="flex items-center gap-1">
                                    <Navigation className="w-3 h-3" />
                                    {route.duration}Î∂Ñ Ï≤¥Î•ò
                                  </span>
                                </div>
                              </div>
                            </div>
                            
                            {!canSelect && !isSelected && (
                              <div className="text-xs text-gray-400">
                                ÏµúÎåÄ {maxRoutes}Í∞úÍπåÏßÄ ÏÑ†ÌÉù Í∞ÄÎä•
                              </div>
                            )}
                          </div>
                        </div>
                      )
                    })}
                    
                    {availableRoutes.length === 0 && (
                      <div className="text-center py-12">
                        <div className="p-4 bg-gray-100 rounded-full w-fit mx-auto mb-4">
                          <Route className="w-8 h-8 text-gray-400" />
                        </div>
                        <p className="text-gray-500 mb-2">ÏóÖÎ°úÎìúÎêú Ïù¥Îèô Í≤ΩÎ°úÍ∞Ä ÏóÜÏäµÎãàÎã§</p>
                        <div className="text-sm text-gray-400 space-y-1">
                          <p>‚Ä¢ ÏßÄÎèÑ Î∑∞ÏóêÏÑú Í≤ÄÏÉâÌïòÏó¨ Ïû•ÏÜåÎ•º Ï∂îÍ∞ÄÌïòÍ±∞ÎÇò</p>
                          <p>‚Ä¢ ÏßÄÎèÑÎ•º ÌÅ¥Î¶≠ÌïòÏó¨ ÏàòÎèôÏúºÎ°ú ÏúÑÏπòÎ•º Ï∂îÍ∞ÄÌïòÏÑ∏Ïöî</p>
                          <p>‚Ä¢ Google ÌÉÄÏûÑÎùºÏù∏ÏùÑ ÏóÖÎ°úÎìúÌïòÎ©¥ ÏûêÎèôÏúºÎ°ú Í≤ΩÎ°úÍ∞Ä ÌëúÏãúÎê©ÎãàÎã§</p>
                        </div>
                      </div>
                    )}
                  </div>
                </CardContent>
              </Card>
            )}
          </div>

          {/* Selection Summary */}
          <div className="lg:col-span-1">
            <Card className="sticky top-24">
              <CardHeader>
                <CardTitle className="text-lg">ÏÑ†ÌÉùÌïú Í≤ΩÎ°ú</CardTitle>
                <CardDescription>
                  ÏÜåÏÑ§Ïóê Ìè¨Ìï®Îê† Ïù¥Îèô Í≤ΩÎ°úÎì§ÏûÖÎãàÎã§
                </CardDescription>
              </CardHeader>
              <CardContent className="space-y-4">
                {selectedRoutes.length > 0 ? (
                  <>
                    <div className="space-y-2">
                      {selectedRoutes.map((route, index) => (
                        <Card
                          key={route.id}
                          className="relative bg-gradient-to-r from-blue-50 to-blue-100 border-blue-200 hover:shadow-md transition-shadow"
                        >
                          <CardContent className="p-3">
                            {/* Ìó§Îçî: Î≤àÌò∏, ÏïÑÏù¥ÏΩò, Ïù¥Î¶Ñ */}
                            <div className="flex items-center gap-2 mb-2">
                              <div className="w-5 h-5 bg-blue-500 text-white rounded-full flex items-center justify-center text-xs font-bold flex-shrink-0">
                                {index + 1}
                              </div>
                              {route.customInfo && (
                                <span className="text-sm flex-shrink-0">
                                  {getCategoryIcon(route.customInfo.category)}
                                </span>
                              )}
                              <h4 className="text-sm font-semibold text-gray-900 truncate flex-1">
                                {route.customInfo?.customName || route.address}
                              </h4>
                              <Button
                                variant="ghost"
                                size="sm"
                                onClick={() => handleRouteToggle(route.id)}
                                className="text-red-500 hover:text-red-700 hover:bg-red-50 p-1 flex-shrink-0 -mr-1"
                              >
                                <X className="w-3 h-3" />
                              </Button>
                            </div>

                            {/* ÏõêÎûò Ï£ºÏÜå (Ïª§Ïä§ÌÖÄ Ïù¥Î¶ÑÏù¥ ÏûàÎäî Í≤ΩÏö∞) */}
                            {route.customInfo?.customName && (
                              <p className="text-xs text-gray-500 mb-2 truncate pl-7">
                                üìç {route.address}
                              </p>
                            )}

                            {/* ÏãúÍ∞Ñ Ï†ïÎ≥¥ */}
                            <div className="flex items-center gap-2 text-xs text-gray-600 mb-2 pl-7">
                              <Clock className="w-3 h-3 flex-shrink-0" />
                              <span>{formatTime(route.timestamp)}</span>
                              {route.duration && (
                                <>
                                  <span>‚Ä¢</span>
                                  <span>{route.duration}Î∂Ñ</span>
                                </>
                              )}
                            </div>

                            {/* Ïû•ÏÜå ÏÑ§Î™Ö */}
                            {route.customInfo?.description && (
                              <div className="mb-2 pl-7">
                                <p 
                                  className="text-xs text-gray-700 bg-white/60 rounded px-2 py-1"
                                  style={{
                                    display: '-webkit-box',
                                    WebkitLineClamp: 2,
                                    WebkitBoxOrient: 'vertical',
                                    overflow: 'hidden'
                                  }}
                                >
                                  {route.customInfo.description}
                                </p>
                              </div>
                            )}

                            {/* Ïä§ÌÜ†Î¶¨ ÌûåÌä∏ */}
                            {route.customInfo?.storyHint && (
                              <div className="pl-7">
                                <Badge variant="secondary" className="text-xs px-2 py-1 bg-yellow-100 text-yellow-800 border-yellow-200">
                                  üí° {route.customInfo.storyHint}
                                </Badge>
                              </div>
                            )}
                          </CardContent>
                        </Card>
                      ))}
                    </div>
                    
                    <Separator />
                    
                    <div className="space-y-3">
                      <div className="flex items-center justify-between text-sm">
                        <span className="text-gray-600">Ï¥ù Í≤ΩÎ°ú Ïàò</span>
                        <span className="font-medium">{selectedRoutes.length}Í∞ú</span>
                      </div>
                      <div className="flex items-center justify-between text-sm">
                        <span className="text-gray-600">ÏòàÏÉÅ ÏÜåÏÑ§ Í∏∏Ïù¥</span>
                        <span className="font-medium">
                          {Math.ceil(selectedRoutes.length * 1.2)}Ï≤úÏûê
                        </span>
                      </div>
                    </div>
                    
                    <Separator />
                    
                    <div className="space-y-2">
                      <Button
                        onClick={handleConfirmSelection}
                        className="w-full"
                        disabled={selectedRoutes.length === 0}
                      >
                        <Check className="w-4 h-4 mr-2" />
                        ÏÑ†ÌÉù ÏôÑÎ£å
                      </Button>
                      <Button
                        variant="outline"
                        onClick={handleClearAll}
                        className="w-full"
                        disabled={selectedRoutes.length === 0}
                      >
                        <Trash2 className="w-4 h-4 mr-2" />
                        Ï†ÑÏ≤¥ Ìï¥Ï†ú
                      </Button>
                    </div>
                  </>
                ) : (
                  <div className="text-center py-8">
                    <div className="p-4 bg-gray-100 rounded-full w-fit mx-auto mb-4">
                      <Plus className="w-8 h-8 text-gray-400" />
                    </div>
                    <p className="text-gray-500 text-sm">
                      ÏïÑÏßÅ ÏÑ†ÌÉùÌïú Í≤ΩÎ°úÍ∞Ä ÏóÜÏäµÎãàÎã§
                    </p>
                    <p className="text-gray-400 text-xs mt-1">
                      ÏµúÎåÄ {maxRoutes}Í∞úÍπåÏßÄ ÏÑ†ÌÉù Í∞ÄÎä•
                    </p>
                  </div>
                )}
              </CardContent>
            </Card>
          </div>
        </div>
      </main>
    </div>
      )}
    </MapContainer>
  )
}